# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.1.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [Unreleased]

### Added
- 天気予報の地域設定機能: GPS現在地 or 都市名検索で天気取得エリアを変更可能
  - WeatherLocation モデル + WeatherLocationNotifier (Riverpod)
  - GeocodingService: Open-Meteo Geocoding API による都市名検索
  - resolvedWeatherCoordsProvider: GPS/手動設定の座標解決 + Tokyo フォールバック
  - WeatherLocationScreen: 設定UI (GPS切替 + 都市検索 + debounce)
  - WeatherService: 座標変更時のキャッシュ自動無効化
  - iOS/Android 位置情報パーミッション設定

### Changed
- 提案タブ: 手動「候補日を検索」ボタンを廃止し、タブ表示時に自動で候補日を生成するように変更

- お問い合わせ画面 (ContactScreen): カテゴリ選択・件名・本文のフォーム付き問い合わせ機能
- 利用規約画面 (TermsOfServiceScreen): 9条構成の利用規約をアプリ内で閲覧可能に
- プライバシーポリシー画面 (PrivacyPolicyScreen): 個人情報保護法準拠の8項目ポリシーをアプリ内で閲覧可能に
- プロジェクト設計ドキュメント一式 (MVP機能スコープ、UI/UX設計、システム設計、技術選定)
- 技術選定最終決定: Flutter + Supabase (PostgreSQL)
- CHANGELOG.md (Keep a Changelog 形式)
- CLAUDE.md (プロジェクト固有の開発ルール)
- GitHub Issue ラベル (feature, bug, chore, docs, refactor, test, P0-P2)
- main ブランチ保護ルール (PR必須)
- .gitignore を Flutter/iOS/Android/Supabase 向けに最適化
- Flutter プロジェクト初期化 (Flutter 3.41.1 / Dart 3.11.0)
- Riverpod + go_router によるアプリ基盤 (app.dart, main.dart, app_router.dart)
- デザインシステム: AppTheme / AppColors (Purple #6C5CE7 ベース)
- ホーム画面スキャフォールド (4タブ: カレンダー/提案/グループ/マイページ)
- ログイン画面スキャフォールド (Apple/Google/LINE ボタン配置)
- コア定数・ユーティリティ (AppConstants, AppDateUtils)
- 依存パッケージ: supabase_flutter, table_calendar, flutter_animate, freezed 等
- データモデル (Freezed v3 + json_serializable): AppUser, Group, GroupMember, Schedule, Suggestion, ShiftPattern, AppNotification
- スケジュール種別 (ScheduleType): shift/event/free/blocked
- 文脈分類 (TimeCategory): morning/lunch/afternoon/evening/all_day
- 天気情報モデル (WeatherSummary): 候補日の天気表示用
- モデル単体テスト (10テスト: fromJson/toJson/copyWith/enum)
- Supabase 初期化 (環境変数ベース: SUPABASE_URL, SUPABASE_ANON_KEY)
- AuthService: Apple/Google OAuth サインイン/サインアウト + Riverpod Provider
- ScheduleService: スケジュール CRUD + リアルタイムストリーム (Supabase stream)
- GroupService: グループ作成/招待コード参加/メンバー管理
- 認証ガード: go_router redirect で未認証時ログイン画面に自動遷移
- 認証状態プロバイダー (authStateProvider, currentUserProvider)
- Supabase CLI 初期化 (supabase init)
- DBスキーマ: 7テーブル + GiST インデックス + CHECK制約 + updated_at トリガー
- RLS ポリシー: 全7テーブルに Row Level Security 設定
- 開発用 seed データ (3ユーザー、1グループ、12スケジュール)
- カレンダーUI: table_calendar 統合 (月/2週/週 表示切替、日本語ロケール)
- スケジュール一覧: 日付タップで当日の予定一覧表示 (種別バッジ + 時刻)
- スケジュール追加/編集画面: 種別選択 (シフト/予定/空き/不可)、日時ピッカー、終日切替、メモ
- スケジュール削除: 確認ダイアログ付き
- ローカル状態管理: LocalSchedulesNotifier (オフラインファースト開発用)
- 日本語ローカライゼーション (flutter_localizations)
- グループ一覧画面 (GroupsTab): 参加グループ一覧 + 空状態表示
- グループ作成ダイアログ: グループ名 + 説明入力
- グループ詳細画面 (GroupDetailScreen): メンバー一覧 + 招待コード表示/コピー/共有
- 招待コード参加ダイアログ: 8桁コード入力 (大文字自動変換 + バリデーション)
- グループ退出機能 (確認ダイアログ付き)
- ローカルグループ状態管理 (LocalGroupsNotifier / LocalGroupMembersNotifier)
- グループ機能テスト (13テスト)
- 候補日提案エンジン (SuggestionEngine): 空き時間重複検出 + 文脈付きアクティビティ提案
  - 30分解像度でメンバー空き時間スキャン (8:00-22:00)
  - TimeCategory 自動分類 (朝/昼/午後/夜/終日)
  - ActivityType 推定 (ランチ/飲み会/カフェ/日帰り旅行 etc.)
  - スコアリング: 可用率 × 時間帯重み × 曜日重み
- 提案タブUI (SuggestionsTab): 候補日カード一覧 + スコア表示 + 参加可能率バー
- 提案カード操作: 承認 (Accept) / 見送り (Decline) ステータス変更
- ローカル提案状態管理 (LocalSuggestionsNotifier)
- 提案エンジンテスト (12テスト)
- マイページUI (ProfileTab): プロフィール表示 + 設定 + アカウント管理
  - プロフィールヘッダー (アバター/表示名編集/グループ数・スケジュール数)
  - 設定: 通知ON/OFF、デフォルト公開範囲 (全員/友達/自分)
  - アカウント: ログアウト (確認ダイアログ付き)
  - アプリ情報: バージョン/利用規約/プライバシーポリシー
- 全4タブのプレースホルダー完全差替 (HomeScreen にプレースホルダーなし)
- デモモード認証: ログイン画面「デモモードで始める」でSupabase未接続でも全機能操作可能
- AuthNotifier: 統合認証状態管理 (none/demo/supabase モード)
- go_router: AuthNotifier ベースのリダイレクトに移行
- main.dart: Supabase 初期化の安全化 (未設定時・接続失敗時もクラッシュしない)
- ProfileTab: デモモードバナー表示 + ログアウトで AuthNotifier.signOut
- .env.example: Supabase 環境変数テンプレート
- 認証テスト (4テスト)
- 投票・確定フロー: 候補日に対してメンバーが「参加OK」「微妙」「NG」の3択で投票
  - Vote モデル (Freezed): userId + suggestionId + voteType (ok/maybe/ng) + displayName
  - LocalVotesNotifier: castVote (投票/再投票)、getUserVote、getVoteSummary、clearVotes
  - SuggestionStatus.confirmed: グループオーナーが「この日に決定」で確定
  - confirmSuggestion: 確定時に同グループの他候補を自動 decline
  - 投票UI: 3色ボタン (緑=OK, 黄=微妙, 赤=NG) + 選択状態のハイライト
  - 投票集計表示: OK/微妙/NG カウント + スタックドバー + 投票者名タグ
  - 確定ボタン: グループオーナーかつ投票あり時のみ表示 + 確認ダイアログ
  - 確定済み候補: 緑ボーダー + 「予定確定！」セレブレーション表示
  - セクション分類: 確定済み / 投票受付中 / 承認済み で候補を整理表示
- 投票テスト (14テスト): Vote モデル、VotesNotifier CRUD、VoteSummary
- グループメンバー予定オーバーレイ (GroupCalendarScreen): メンバー全員の予定を重ね合わせたカレンダービュー
  - メンバー色分け凡例 (最大8色) + カレンダー上にメンバー別カラードット表示
  - 「全員空き」の日をグリーンハイライト (今後30日分を自動検出)
  - 日付タップでメンバー別予定一覧表示 (予定タイプ色付きドット + 時間帯 + タイトル)
  - デモモード: 他メンバーのシミュレーション予定自動生成 (~40%の日にランダム予定)
  - グループ詳細画面に「メンバーのカレンダーを見る」ナビゲーションボタン追加
- 全30機能メガ実装 (feature/all-features-mega-implementation)
  - テーマ・きせかえ: ThemePreset 6色 (紫/ピンク/青/緑/オレンジ/モノ) + ダークモード切替
  - 天気予報統合: Open-Meteo API 14日予報、候補日スコアに天気重み反映 (±15%)
    - カレンダーセル・候補詳細ボトムシートに天気アイコン・気温表示
    - 雨天時は屋内アクティビティ (カラオケ/映画) を自動提案
  - 給料計算: 月間/年間の給料計算、残業/深夜/休日手当、税壁警告 (103万/130万/150万)
  - 勤務先設定: 勤務先CRUD (名前/時給/締め日/各種割増率/交通費)
  - シフトパターン: ローテーション管理 (早番/遅番/夜勤 等)
  - カレンダー同期設定: Apple/Google カレンダー同期トグル
  - テンプレート: よく使う予定テンプレート管理 (アイコン/色付き)
  - チャット: グループチャット (テキスト/画像/システムメッセージ、リアクション、既読)
  - アクティビティフィード: タイムライン (予定追加/投票/確定 等のイベント)
  - ToDo リスト: 共有タスク管理 (担当者アサイン/期限/完了チェック)
  - 投票: グループ投票 (単一/複数選択、匿名、締切、リアルタイム結果)
  - アルバム: 写真共有 (グリッド表示、キャプション、リアクション)
  - 掲示板: コミュニティボード (投稿/コメント/リアクション、ピン留め)
  - 割り勘: 経費トラッカー (均等/カスタム分割、精算計算)
  - ヒートマップ: 空き状況ヒートマップ
  - 週間ビュー: 7日カラム + 時間帯スロット表示
  - 日間ビュー: 24時間タイムライン表示
  - 履歴・統計: 確定済み予定の履歴 + 統計情報
  - ウェルビーイング: 気分/エネルギー/ストレストラッカー + 習慣管理
  - 予約ページ: 空き時間公開 + 予約受付設定
  - SNS共有カード: 確定予定のシェアカード画像生成
  - 公開投票URL: URL経由での投票ページ管理
  - 通知設定: カテゴリ別通知ON/OFF + グループ別ミュート + リマインダー設定
  - 自然言語入力: 日本語テキスト→予定変換 (「来週火曜18時から飲み会@渋谷」)
  - 繰り返し予定: iCalendar RRULE パーサー (DAILY/WEEKLY/MONTHLY/YEARLY)
  - AI学習エンジン: 確定パターンから好みを学習 (時間帯/曜日/アクティビティ)
  - iCal/CSV/PDFエクスポート: 予定の外部出力
  - 12個の新Freezedモデル: Workplace, ChatMessage, Activity, TodoItem, Poll, Photo, Expense, EventTemplate, Habit, MoodEntry, BookingPage, Post
  - 14個の新Provider: 各機能のNotifier + family Provider
  - 7個の新サービス: WeatherService, SalaryCalculator, ChatService, ExportService, ShareCardGenerator, LearningEngine, RRuleParser

### Fixed
- セキュリティ: WeatherService に TimeoutException/FormatException 明示的ハンドリング追加
- セキュリティ: ChatService に入力サニタイズ (5000字制限 + 制御文字除去)
- セキュリティ: NaturalLanguageParser に ReDoS ガード (500字制限)
- バグ: SalaryCalculator の深夜勤務控除で残業時間が負になりうる問題を .clamp() で修正
- UI: 未到達画面6つをUIに接続 (WeekView/DayView/QuickInputField/ShiftPattern/ShareCard/PublicVote)
  - カレンダータブに月/週/日表示切替 (SegmentedButton) を追加
  - プロフィールタブにシフトパターン画面へのナビゲーション追加
  - 候補タブに確定候補のシェアカード作成ボタン追加
  - 候補タブに公開投票画面へのアクセスボタン追加
- 法的リスク: ソースコード doccomment から競合アプリ名参照を削除 (5ファイル)
- 法的リスク: CHANGELOG から競合サービス名表現を中立化
- 法的リスク: app_theme.dart のコメントから競合サービス名を削除
- ライセンス: Open-Meteo CC-BY 4.0 帰属表示をアプリ情報セクションに追加
- セキュリティ: album_screen.dart の外部画像サービス (picsum.photos) 参照を削除
